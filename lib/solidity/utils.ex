defmodule Solidity.Utils do
  @moduledoc """
  Utility functions
  """

  @doc """
  Helps transform the output from the solc compiler to binary data.

  ## Example

  ```sh
  solc --bin priv/sols/Add.sol

  ======= priv/sols/Add.sol:Add =======
  Binary:
  608060405234801561001057600080fd5b50610245806100206000396000f3fe608060405234801561001057600080fd5b50600436106100365760003560e01c806304c402f41461003b5780636d4ce63c14610057575b600080fd5b610055600480360381019061005091906100e2565b610075565b005b61005f61009d565b60405161006c9190610131565b60405180910390f35b8160008190555080600181905550600154600054610093919061017b565b6002819055505050565b6000600254905090565b600080fd5b6000819050919050565b6100bf816100ac565b81146100ca57600080fd5b50565b6000813590506100dc816100b6565b92915050565b600080604083850312156100f9576100f86100a7565b5b6000610107858286016100cd565b9250506020610118858286016100cd565b9150509250929050565b61012b816100ac565b82525050565b60006020820190506101466000830184610122565b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000610186826100ac565b9150610191836100ac565b9250817f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff038313600083121516156101cc576101cb61014c565b5b817f80000000000000000000000000000000000000000000000000000000000000000383126000831216156102045761020361014c565b5b82820190509291505056fea26469706673582212205fa061faab78143cc67281ab2f381a7ab6381556506d9a6ffa0db87afc7d91e964736f6c634300080e0033
  ```
  """
  @spec output_to_binary(String.t()) :: {:ok, binary()} | {:error, String.t()}
  def output_to_binary(output) do
    output |> String.split() |> do_output_to_binary()
  end

  defp do_output_to_binary(["=======", _, "=======", "Binary:", output]) do
    case Base.decode16(String.upcase(output)) do
      {:ok, data} -> {:ok, data}
      :error -> {:error, "unabel to decode binary string"}
    end
  end

  defp do_output_to_binary([_ | output]) do
    do_output_to_binary(output)
  end

  defp do_output_to_binary([]) do
    {:error, "unable to parse solc output"}
  end
end
